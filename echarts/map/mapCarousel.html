<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>全国，省，地级市轮播</title>
  <style>
    #myChart {
      width: 100%;
      height: 600px;
      border: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div>
    <h1 style="display: inline"></h1>
    <h2 style="display: inline"></h2>
  </div>
  <button type="button" style="margin-bottom: 10px" onclick="reTry()">重新开始</button>
  <button type="button" style="margin-bottom: 10px" id="stop" onclick="stop()">暂停</button>
  <div id="myChart"></div>
  <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.0.1/echarts.min.js"></script>
  <script>
    const option = {
      series: [{
        name: '采集量',
        type: 'map',
        mapType: '',
        roam: true,
        scaleLimit: {
          min: 1,
          max: 5
        },
        label: {
          normal: {
            show: true,
            textStyle: {
              color: 'rgba(0,0,0,0.7)',
              fontSize: 10
            },
          },
        },
        itemStyle: {
          normal: {
            borderColor: 'rgba(0, 0, 0, 0.2)',
          },
          emphasis: {
            areaColor: '#f2d5ad',
          }
        },
        data: [],
      }]
    };
    const myChart = echarts.init(document.getElementById('myChart'));

    const interval = 1000; // 间隔
    let address = null;
    let provinceIdx = 0;
    let cityIdx = 0;
    let timeoutId = null;
    // 直辖市，港澳台
    const Municipality = ['110000', '120000', '310000', '500000', '710000', '810000', '910000'];
    const cities = ['419000']; // 省直辖

    request('./address.json')
      .then((res) => {
        console.log('城市列表', res);
        address = res;
        draw({
          mapType: 'china',
          provinceName: '全国',
          callback() {
            provinceDraw();
          }
        });
      });

    function request(url) {
      return fetch(url).then(res => res.json());
    }

    function draw({
      mapType,
      provinceName,
      cityName = '',
      callback,
    }) {
      if (document.querySelector('h1').innerText !== provinceName) {
        document.querySelector('h1').innerText = provinceName;
      }
      document.querySelector('h2').innerText = cityName;
      request(`./geoJson/${mapType}.json`)
        .then((geoJson) => {
          echarts.registerMap(mapType, geoJson);
          option.series[0].mapType = mapType;
          myChart.setOption(option);
          if (callback) {
            timeoutId = setTimeout(() => {
              callback();
            }, interval);
          }
        });
    }

    function cityDraw(province) {
      const city = province.children[cityIdx];
      const callback = () => {
        if (cityIdx < province.children.length - 1) {
          cityIdx++;
          cityDraw(province);
        } else if (provinceIdx < address.length - 1) {
          cityIdx = 0;
          provinceIdx++;
          provinceDraw();
        } else if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
      };
      if (cities.includes(city.id)) {
        callback();
      } else {
        draw({
          mapType: city.id,
          provinceName: province.name,
          cityName: city.name,
          callback,
        });
      }
    }

    function provinceDraw() {
      const province = address[provinceIdx];
      draw({
        mapType: province.id,
        provinceName: province.name,
        callback() { 
          if (!Municipality.includes(province.id)) {
            cityDraw(province);
          } else if (provinceIdx < address.length - 1) {
            provinceIdx++;
            provinceDraw();
          } else if (timeoutId) {
            clearTimeout(timeoutId);
            timeoutId = null;
          }
        }
      });
    }

    function stop() {
      if (timeoutId) {
        document.querySelector('#stop').innerText = '开始';
        clearTimeout(timeoutId);
        timeoutId = null;
      } else {
        document.querySelector('#stop').innerText = '暂停';
        const province = address[provinceIdx];
        if (!Municipality.includes(province.id)) {
          cityDraw(province);
        } else if (provinceIdx < address.length - 1) {
          provinceIdx++;
          provinceDraw();
        } else if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
      }
    }

    function reTry() {
      document.querySelector('#stop').innerText = '暂停';
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }
      provinceIdx = 0;
      cityIdx = 0;
      draw({
        mapType: 'china',
        provinceName: '全国',
        callback() {
          provinceDraw();
        }
      });
    }
  </script>
</body>
</html>
